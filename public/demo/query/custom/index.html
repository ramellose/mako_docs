<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://ramellose.github.io/mako_docs/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://ramellose.github.io/mako_docs/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=https://ramellose.github.io/mako_docs/main.c72284d0eb7d7b668ff042e4dd40adf86844b461621ef01690336c9856175e7e433fbebfaf31e0f36a88d1059cfd8a1b7046d56e9e20f19819c03c555eafdc92.css integrity="sha512-xyKE0Ot9e2aP8ELk3UCt+GhEtGFiHvAWkDNsmFYXXn5DP76/rzHg82qI0QWc/YobcEbVbp4g8ZgZwDxVXq/ckg==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Writing custom queries - mako</title><meta name=description content="Mako helps you structure data from multiple networks to carry out better meta-analyses. "><link rel=canonical href=https://ramellose.github.io/mako_docs/demo/query/custom/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/mako.png"><meta name=twitter:title content="Writing custom queries"><meta name=twitter:description content="Find all Python code used on this page here: custom_queries.py
All of mako&rsquo;s driver classes are able to use the functions that call custom queries, so there is no need to close and recreate the driver to use these functions; however, for the sake of simplicity, the code below calls the ParentDriver class.
First, we need to start up the driver and connect to the database.
from mako.scripts.utils import ParentDriverdriver = ParentDriver(uri='neo4j://localhost:7688',user='neo4j',password='test',filepath=filepath,encrypted=False)The ParentDriver only has three class methods: close, query and write."><meta name=twitter:site content="@rutjers"><meta name=twitter:creator content="@rutjers"><meta property="og:title" content="Writing custom queries"><meta property="og:description" content="Find all Python code used on this page here: custom_queries.py
All of mako&rsquo;s driver classes are able to use the functions that call custom queries, so there is no need to close and recreate the driver to use these functions; however, for the sake of simplicity, the code below calls the ParentDriver class.
First, we need to start up the driver and connect to the database.
from mako.scripts.utils import ParentDriverdriver = ParentDriver(uri='neo4j://localhost:7688',user='neo4j',password='test',filepath=filepath,encrypted=False)The ParentDriver only has three class methods: close, query and write."><meta property="og:type" content="article"><meta property="og:url" content="/demo/query/custom/"><meta property="og:image" content="/mako.png"><meta property="article:published_time" content="2021-04-28T13:57:41+02:00"><meta property="article:modified_time" content="2021-04-28T13:57:41+02:00"><meta property="og:site_name" content="mako"><meta property="article:publisher" content="https://www.facebook.com/rottjers.sam"><meta property="article:author" content="https://www.facebook.com/rottjers.sam"><meta property="og:locale" content="en_US"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/ramellose.github.io\/mako_docs"},{"@type":"ListItem","position":3,"name":"Demo","item":"https:\/\/ramellose.github.io\/mako_docs\/demo\/"},{"@type":"ListItem","position":4,"name":"Query","item":"https:\/\/ramellose.github.io\/mako_docs\/demo\/query\/"},{"@type":"ListItem","position":5,"name":"Custom","item":"https:\/\/ramellose.github.io\/mako_docs\/demo\/query\/custom\/"}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://ramellose.github.io/mako_docs/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://ramellose.github.io/mako_docs/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://ramellose.github.io/mako_docs/favicon-16x16.png><link rel=manifest href=https://ramellose.github.io/mako_docs/site.webmanifest></head><body class="demo single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 me-auto" href=https://ramellose.github.io/mako_docs/>mako</a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://twitter.com/rutjers><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg><span class="ms-2 visually-hidden">Twitter</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/ramellose/mako><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ms-2 visually-hidden">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav me-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=https://ramellose.github.io/mako_docs/info/mako/abstract/>About</a></li><li class=nav-item><a class=nav-link href=https://ramellose.github.io/mako_docs/quickstart/guide>Quickstart</a></li><li class=nav-item><a class=nav-link href=https://ramellose.github.io/mako_docs/installation/instructions/conda>Installation</a></li><li class=nav-item><a class=nav-link href=https://ramellose.github.io/mako_docs/demo/vignette/intro>Demo</a></li><li class=nav-item><a class=nav-link href=https://ramellose.github.io/mako_docs/manual/introduction/intro>Manual</a></li><li class=nav-item><a class=nav-link href=https://ramellose.github.io/mako_docs/neo4j/introduction/intro>Neo4j</a></li><li class=nav-item><a class=nav-link href=https://ramellose.github.io/mako_docs/cypher/introduction/intro>Cypher</a></li><li class=nav-item><a class=nav-link href=https://ramellose.github.io/mako_docs/examples/intro>Cases</a></li><li class=nav-item><a class=nav-link href=https://ramellose.github.io/mako_docs/blog/>Blog</a></li></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input id=userinput class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded"></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><h3>Pisaster</h3><ul class=list-unstyled><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/pisaster/intro/>Paine's food web</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/pisaster/pisaster/>Predator-prey interactions</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/pisaster/schemas/>Food web schemas</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/pisaster/connect/>Connect to Neo4j</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/pisaster/create/>Creating the food web</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/pisaster/query/>Querying the food web</a></li></ul><h3>mako</h3><ul class=list-unstyled><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/vignette/intro/>Demo data</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/vignette/access/>Set up database</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/vignette/biom/>Uploading BIOM file</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/vignette/networks/>Uploading networks</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/vignette/intersection/>Constructing intersection</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/vignette/metadata/>Calculate metadata correlations</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/vignette/taxonomy/>Merge network by taxonomy</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/vignette/cytoscape/>Export to Cytoscape</a></li></ul><h3>Custom queries</h3><ul class=list-unstyled><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/query/intro/>Working with Python scripts</a></li><li><a class=docs-link href=https://ramellose.github.io/mako_docs/demo/query/setup/>Setting up the database</a></li><li><a class="docs-link active" href=https://ramellose.github.io/mako_docs/demo/query/custom/>Writing custom queries</a></li></ul></nav></div><main class="docs-content col-lg-11 col-xl-9"><h1>Writing custom queries</h1><p class=lead></p><p>Find all Python code used on this page here: <a href=https://ramellose.github.io/mako_docs/demo/custom_queries.py>custom_queries.py</a><br><br>All of mako&rsquo;s driver classes are able to use the functions that call custom queries, so there is no need to close and recreate the driver to use these functions; however, for the sake of simplicity, the code below calls the <code>ParentDriver</code> class.</p><p>First, we need to start up the driver and connect to the database.</p><pre><code>
from mako.scripts.utils import ParentDriver

driver = ParentDriver(uri='neo4j://localhost:7688',
                      user='neo4j',
                      password='test',
                      filepath=filepath,
                      encrypted=False)
</pre></code><p>The <code>ParentDriver</code> only has three class methods: <code>close</code>, <code>query</code> and <code>write</code>. The <code>close</code> method closes the connection to the Neo4j database. There is no need to run this every time you run a query, but it can be helpful to include it in a script so you are not opening many connections at a time. The <code>query</code> processes a read transaction, while the <code>write</code> processes a write transaction. Both of these methods require a Cypher query as input, but only the <code>write</code> method can make changes to the database.</p><p>Let&rsquo;s first take a look at the structure of some simple query results.
We will use this query:<br><code>MATCH p=(:Genus {name: &lsquo;g__Escherichia&rsquo;})&ndash;(:Taxon)&ndash;(:Edge) RETURN p</code><br><br></p><p>The query returns a pattern <code>p</code>, which consists of a <code>Genus</code> node, a <code>Taxon</code> node and an <code>Edge</code> node. When we run the query, we will get a list of all results; the section below shows our first result.</p><pre><code>
query = "MATCH p=(:Genus {name: 'g__Odoribacter'})--(:Taxon)--(:Edge) RETURN p"
query_results = driver.query(query)

print(len(query_results))
print(query_results[0])

10
{'p': [{'name': 'g__Odoribacter'}, 
        'MEMBER_OF', 
        {'name': '11947-agglom-107'}, 
        'PARTICIPATES_IN', 
        {'name': '7c942282-a6f1-4d38-b7e0-8ac3d89f69b1', 'weight': -0.30529758442530924}]}
</pre></code><p>We can see that the query result is returned as a dictionary, with each value (in this case only <code>p</code>) as a key in the dictionary. The value is a list, with each item in the list representing an item in the path. Nodes are returned as dictionaries, the other values are relationship labels.</p><p>To access values in the query, it can be helpful to process them. Neo4j does not keep track of the &ldquo;direction&rdquo; of the pattern matching; if a pattern matches the same three nodes in two ways (e.g. A&ndash;B&ndash;C and C&ndash;B&ndash;A), both matches will be returned as results. When studying motifs, it is therefore crucial to filter out these duplicates.</p><p>The script below does exactly this: it first makes a list of lists, with each sublist containing all node names (not relationships) in each pattern. The sublists are then sorted. Next, the set of each sublist is taken, so that they only contain unique nodes. For this query, this step is not actually necessary, but for loops like (A&ndash;B&ndash;C&ndash;A) it makes sure that we do not return (B&ndash;C&ndash;A&ndash;B) too. Finally, we return only unique sublists.</p><pre><code>
all_nodes = [[y['name'] for y in x['p'] if type(y) == dict] for x in query_results]
for y in all_nodes:
    y.sort()
all_nodes = [set(x) for x in all_nodes]
all_nodes = set(map(tuple, all_nodes))
</code></pre><p>Note that, if we change the query, we may need to change our queries to go along with this. For example, we can choose to return the genus assignment of the association partners rather than the pattern above. There is no need to specify the <code>Taxon</code> nodes, since the only connection between <code>Genus</code> and <code>Edge</code> nodes is via taxa.</p><pre><code>
query = "MATCH (:Genus {name: 'g__Odoribacter'})--()--(:Edge)--()--(n:Genus) RETURN n"
query_results = driver.query(query)

print(len(query_results))
print(query_results[0])

8
{'n': {'name': 'g__[Ruminococcus]'}}
</code></pre><p>We actually have fewer matches than before. Apparently, not all associations are with taxa that have a genus assignment. Morever, we can see that the structure of the results is the same; we get a dictionary that has a key identical to the parameter in our Cypher <code>RETURN</code> and a value that is a node dictionary.</p><p>If we are interested in finding those associations without a genus assignment, we can actually add this to the query. The <code>WHERE NOT</code> clause states that the node <code>n</code> cannot have a link to a <code>Genus</code>, while the <code>WITH</code> clause then uses this node to return the pattern matching the <code>Family</code> node.</p><pre><code>
query = "MATCH (:Genus {name: 'g__Odoribacter'})--()--(:Edge)--(n) 
         WHERE NOT (n)--(:Genus) 
         WITH n MATCH p=(n)--(:Family) RETURN p"
query_results = driver.query(query)

print(len(query_results))
print(query_results[0])

2
{'p': [{'name': '11947-agglom-78'}, 'MEMBER_OF', {'name': 'f__[Barnesiellaceae]'}]}
</code></pre><p>Finally, it is also possible that we may have specified a query that is technically correct, but the pattern does not match to any data in the database. For example, <code>Genus</code> nodes can only connect to <code>Taxon</code> nodes, and <code>Taxon</code> nodes cannot directly connect to a <code>Network</code> node. In this case, the query results are just an empty list.</p><pre><code>
query = "MATCH p=(:Genus {name: 'g__Odoribacter'})--()--(:Network) RETURN p"
query_results = driver.query(query)

print(query_results)

[]
</code></pre><div class="alert alert-warning d-flex" role=alert><div class="flex-shrink-1 alert-icon">ðŸ‘‰</div><div class=w-100>To clear the database for future use, run the query MATCH (n) DETACH DELETE n.</div></div><p class=edit-page><a href=https://github.com/ramellose/mako/blob/master/content/demo/query/custom.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://ramellose.github.io/mako_docs/demo/query/setup/><div class="card my-1"><div class="card-body py-2">&larr; Setting up the database</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a href=https://www.netlify.com/>Netlify</a>, <a href=https://gohugo.io/>Hugo</a>, and <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://ramellose.github.io/mako_docs/js/highlight.min.2c793eb7599ae4975966407f455873eca25c0dd1146f2ba6a8ca933c3ee5a244f8e3a48c5b73694a76709db65ff3e7eedf2a55fc3b0c03510b2eca2b8635c8da.js integrity="sha512-LHk+t1ma5JdZZkB/RVhz7KJcDdEUbyumqMqTPD7lokT446SMW3NpSnZwnbZf8+fu3ypV/DsMA1ELLsorhjXI2g==" crossorigin=anonymous defer></script><script src=https://ramellose.github.io/mako_docs/main.min.7ab523108435955765bcb88a0ee704f412ba01646b5478e84f3b9feb24f0ce750a14c3f7bd9a62408fe21e41996d361a9eb29f77e85dfe77b7e17f7623bd3a97.js integrity="sha512-erUjEIQ1lVdlvLiKDucE9BK6AWRrVHjoTzuf6yTwznUKFMP3vZpiQI/iHkGZbTYanrKfd+hd/ne34X92I706lw==" crossorigin=anonymous defer></script><script src=https://ramellose.github.io/mako_docs/index.min.5e8c22dd194cfee3a044521843fbc27a255e6102168b12ed8809dfb1de332d15b617b4489a9094a3bf0e62a0ae1996ca723c804294ee709e0b5ff4feb645b8ee.js integrity="sha512-Xowi3RlM/uOgRFIYQ/vCeiVeYQIWixLtiAnfsd4zLRW2F7RImpCUo78OYqCuGZbKcjyAQpTucJ4LX/T+tkW47g==" crossorigin=anonymous defer></script></body></html>